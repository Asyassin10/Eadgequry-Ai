version: "3.9"

# Docker Compose file for running tests and SonarQube scanning
# Usage: docker-compose -f docker-compose.scanner.yml run --rm auth-scanner

services:
  # Maven test runner and SonarQube scanner for Auth service
  auth-scanner:
    image: maven:3.9.6-eclipse-temurin-21
    container_name: auth-scanner
    volumes:
      - ./auth:/workspace
      - maven-cache:/root/.m2
    working_dir: /workspace
    networks:
      - edagequry-net
    command: >
      bash -c "
      echo '========================================' &&
      echo 'Running tests for Auth Service...' &&
      echo '========================================' &&
      mvn clean test jacoco:report &&
      echo '' &&
      echo '========================================' &&
      echo 'Uploading to SonarQube...' &&
      echo '========================================' &&
      mvn sonar:sonar -Dsonar.host.url=http://sonarqube:9000
      "

  # Maven test runner and SonarQube scanner for Profile service
  profile-scanner:
    image: maven:3.9.6-eclipse-temurin-21
    container_name: profile-scanner
    volumes:
      - ./user-profile:/workspace
      - maven-cache:/root/.m2
    working_dir: /workspace
    networks:
      - edagequry-net
    command: >
      bash -c "
      echo '========================================' &&
      echo 'Running tests for Profile Service...' &&
      echo '========================================' &&
      mvn clean test jacoco:report &&
      echo '' &&
      echo '========================================' &&
      echo 'Uploading to SonarQube...' &&
      echo '========================================' &&
      mvn sonar:sonar -Dsonar.host.url=http://sonarqube:9000
      "

  # Maven test runner and SonarQube scanner for Notification service
  notification-scanner:
    image: maven:3.9.6-eclipse-temurin-21
    container_name: notification-scanner
    volumes:
      - ./notification:/workspace
      - maven-cache:/root/.m2
    working_dir: /workspace
    networks:
      - edagequry-net
    command: >
      bash -c "
      echo '========================================' &&
      echo 'Running tests for Notification Service...' &&
      echo '========================================' &&
      mvn clean test jacoco:report &&
      echo '' &&
      echo '========================================' &&
      echo 'Uploading to SonarQube...' &&
      echo '========================================' &&
      mvn sonar:sonar -Dsonar.host.url=http://sonarqube:9000
      "

networks:
  edagequry-net:
    external: true

volumes:
  maven-cache:
